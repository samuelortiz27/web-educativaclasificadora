{% extends 'ecoeduca/base.html' %}
{% load static %}

{% block title %}Clasificador de Residuos{% endblock %}

{% block content %}
<div class="ecoedu-clasificador container mt-5">
    <div class="card shadow-lg p-4 text-center mx-auto ecoedu-clasificador-card">
        <h1 class="ecoedu-clasificador-titulo mb-3">Clasificador de Residuos</h1>
        <p class="ecoedu-clasificador-descripcion mb-4">
            Sube una imagen o toma una foto para identificar el tipo de residuo.
        </p>

        <form method="post" enctype="multipart/form-data" class="mb-4">
            {% csrf_token %}

            <input id="inputImagen" type="file" name="imagen" accept="image/*" class="form-control mb-3">

            <button type="button" class="btn btn-secondary w-100 mb-3" onclick="activarCamara()">
                <i class="bi bi-camera-fill me-2"></i> Usar c√°mara
            </button>

            <div id="camaraContainer" style="display:none;">
                <video id="video" width="100%" autoplay class="rounded border shadow-sm"></video>

                <button type="button" class="btn btn-primary mt-2" onclick="capturarFoto()">
                    Tomar foto
                </button>

                <canvas id="canvas" style="display:none;"></canvas>
            </div>

            <button type="submit" class="btn btn-success ecoedu-btn w-100">Clasificar</button>
        </form>

        {% if imagen_url %}
        <div class="ecoedu-imagen mb-3">
            <img src="{{ imagen_url }}" alt="Imagen subida" class="img-fluid rounded shadow-sm" style="max-width: 300px;">
        </div>
        {% endif %}

        {% if resultado %}
        <div class="alert alert-info mt-3">
            <strong>Resultado:</strong> {{ resultado }}
        </div>

        <div class="ecoedu-info mt-3 p-3 rounded"
            style="background-color: {{ color_contenedor }}; color: {{ text_color }};">
            {{ info }}
        </div>

        {% if contenedor_img %}
        <div class="ecoedu-contenedor mt-4">
            <h4>Contenedor recomendado:</h4>
            <img src="{{ contenedor_img }}" alt="Contenedor" class="img-fluid" style="max-width: 180px;">
        </div>
        {% endif %}

        {% if puntos_relacionados %}
        <div class="mt-4 p-3 rounded shadow-sm bg-light text-start">
            <h4 class="mb-3 text-success">‚ôªÔ∏è Puntos de reciclaje cercanos:</h4>
            <ul class="list-group mb-3">
                {% for punto in puntos_relacionados %}
                <li class="list-group-item">
                    <strong>{{ punto.nombre }}</strong><br>
                    <span class="text-muted">{{ punto.direccion }}</span><br>

                    {% if punto.descripcion %}
                        <small>{{ punto.descripcion }}</small><br>
                    {% endif %}
                    {% if punto.telefono %}
                        <small>üìû {{ punto.telefono }}</small>
                    {% endif %}
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No se encontraron puntos de reciclaje relacionados.</li>
                {% endfor %}
            </ul>

            <div id="map" style="height: 400px; width: 100%;"></div>
        </div>
        {% endif %}
        {% endif %}

        <div class="text-center mt-4">
            <a href="{% url 'ecoeduca:inicio' %}" class="btn btn-success ecoedu-btn">
                <i class="bi bi-arrow-left-circle"></i> Volver al inicio
            </a>
        </div>
    </div>
</div>

<script>
let video = null;
let stream = null;

function activarCamara() {
    document.getElementById("camaraContainer").style.display = "block";

    video = document.getElementById("video");

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
            stream = s;
            video.srcObject = s;
        })
        .catch(err => alert("No se pudo acceder a la c√°mara: " + err));
}

function capturarFoto() {
    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    canvas.toBlob(blob => {
        const archivo = new File([blob], "foto.jpg", { type: "image/jpeg" });
        const input = document.getElementById("inputImagen");

        const dt = new DataTransfer();
        dt.items.add(archivo);
        input.files = dt.files;

        input.required = true;

        alert("üì∏ Foto capturada exitosamente.");

        stream.getTracks().forEach(t => t.stop());
        document.getElementById("camaraContainer").style.display = "none";
    });
}
</script>

{% if puntos_relacionados %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
var map = L.map('map').setView([0, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var bounds = [];

{% for punto in puntos_relacionados %}
    {% if punto.latitud and punto.longitud %}
        var marker = L.marker([{{ punto.latitud }}, {{ punto.longitud }}]).addTo(map)
            .bindPopup("<strong>{{ punto.nombre }}</strong><br>{{ punto.direccion }}");
        bounds.push([{{ punto.latitud }}, {{ punto.longitud }}]);
    {% endif %}
{% endfor %}

if(bounds.length > 0){
    map.fitBounds(bounds);
}
</script>
{% endif %}
{% endblock %}
